<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Pes√©e du Poulet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        @media print {
            .no-print { display: none; }
        }
        .pesee-item {
            transition: all 0.2s ease-in-out;
        }
        .pesee-item:hover {
            transform: translateY(-2px);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background-color: #10B981;
            color: white;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .toast.show {
            opacity: 1;
        }
        .locked {
            position: relative;
        }
        .locked::after {
            content: "üîí";
            position: absolute;
            top: 0;
            right: 0;
            padding: 2px 5px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 0 0 0 5px;
        }
        .blurred {
            filter: blur(3px);
            pointer-events: none;
            user-select: none;
        }
        .offline-indicator {
            position: fixed;
            top: 10px;
            left: 10px;
            background: #F59E0B;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1002;
        }
        .tab-button {
            padding: 8px 16px;
            border: none;
            background: #f3f4f6;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
        }
        .tab-button.active {
            background: #3b82f6;
            color: white;
        }
        .tab-content {
            display: none;
            padding: 16px;
            border: 1px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 4px 4px;
        }
        .tab-content.active {
            display: block;
        }
        .pesee-item button {
            transition: all 0.2s ease-in-out;
        }
        .pesee-item button:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 p-4">
    <div id="offlineIndicator" class="offline-indicator hidden">‚ö†Ô∏è Mode hors ligne</div>

    <div class="max-w-7xl mx-auto">
        <!-- Toast Notification -->
        <div id="toast" class="toast"></div>

        <!-- Password Protection Overlay -->
        <div id="passwordOverlay" class="fixed inset-0 bg-white bg-opacity-90 z-50 flex items-center justify-center hidden">
            <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Acc√®s prot√©g√©</h2>
                <p class="text-gray-600 mb-6">Veuillez entrer le mot de passe pour modifier cette pes√©e.</p>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Mot de passe</label>
                    <input type="password" id="passwordInput" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Entrez le mot de passe">
                </div>
                
                <div class="flex gap-2">
                    <button onclick="hidePasswordOverlay()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                        Annuler
                    </button>
                    <button onclick="checkPassword()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Valider
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div id="mainContent" class="bg-white rounded-lg shadow-xl p-6">
            <!-- Header with navigation -->
            <div class="flex items-center gap-3 mb-6">
                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"></path>
                </svg>
                <div class="flex-1">
                    <h1 class="text-3xl font-bold text-gray-800" id="currentPeseeTitle">La Pes√©e du Poulet</h1>
                    <div class="text-sm text-gray-500 flex items-center gap-4 mt-1">
                        <span id="currentPeseeDate">Date: -</span>
                        <span id="currentPeseeAge">√Çge: -</span>
                        <span id="currentPeseeBuilding">B√¢timent: -</span>
                    </div>
                </div>
                <div class="ml-auto flex gap-2 no-print">
                    <button onclick="showPeseeListModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 text-sm font-medium">
                        üìã Liste des Pes√©es
                    </button>
                    <button onclick="toggleLock()" id="lockButton" class="px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 text-sm font-medium">
                        üîì D√©verrouiller
                    </button>
                    <button onclick="duplicateCurrentPesee()" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 text-sm font-medium">
                        Dupliquer
                    </button>
                    <button onclick="saveCurrentPeseeWithFeedback()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium">
                        Sauvegarder
                    </button>
                    <button onclick="showDeleteModal()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 text-sm font-medium">
                        Supprimer
                    </button>
                    <button onclick="exportPDF()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 text-sm font-medium">
                        PDF
                    </button>
                    <button onclick="exportCSV()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm font-medium">
                        CSV
                    </button>
                    <button onclick="exportJSON()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium">
                        JSON
                    </button>
                    <button onclick="window.print()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 text-sm font-medium">
                        Print
                    </button>
                </div>
            </div>

            <!-- Rest of the content -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">L'Age (jours)</label>
                    <input type="text" id="age" value="79" class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="saveCurrentPesee()" disabled>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                    <input type="text" id="date" value="07/09/2022" class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="saveCurrentPesee()" disabled>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">B√¢timent N¬∞</label>
                    <input type="text" id="building" value="" class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="saveCurrentPesee()" disabled>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Poids Norme (PN)</label>
                    <input type="number" id="targetWeight" value="2045" class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="saveCurrentPesee()" disabled>
                </div>
            </div>

            <div class="bg-gray-50 rounded-lg p-4 overflow-x-auto">
                <h2 class="text-lg font-semibold text-gray-800 mb-3">
                    Pes√©es (108 poulets en 6 groupes de 18)
                </h2>
                <div id="groupsContainer" class="flex flex-col gap-6"></div>
            </div>

            <div class="mt-6 mb-4 flex gap-4 text-sm flex-wrap">
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-blue-200 border border-blue-400"></div>
                    <span id="upperLimitText">‚â• 0 (PMG+10%)</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-yellow-100 border border-yellow-400"></div>
                    <span>Normal</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-red-200 border border-red-400"></div>
                    <span id="lowerLimitText">‚â§ 0 (PMG-10%)</span>
                </div>
            </div>

            <div class="bg-gradient-to-r from-green-100 to-blue-100 rounded-lg p-6 mt-6">
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                    <div class="bg-white rounded-lg p-4 shadow">
                        <div class="text-xs text-gray-600 mb-1">PMG</div>
                        <div id="pmg" class="text-xl font-bold text-green-700">0</div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow">
                        <div class="text-xs text-gray-600 mb-1">PN</div>
                        <div id="pn" class="text-xl font-bold text-blue-700">2045</div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow">
                        <div class="text-xs text-gray-600 mb-1">ECART (%)</div>
                        <div id="ecart" class="text-xl font-bold">0</div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow">
                        <div class="text-xs text-gray-600 mb-1">H (‚â•PMG+10%)</div>
                        <div id="h" class="text-xl font-bold text-blue-700">0</div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow">
                        <div class="text-xs text-gray-600 mb-1">H %</div>
                        <div id="hPercent" class="text-xl font-bold text-blue-700">0</div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow">
                        <div class="text-xs text-gray-600 mb-1">Bas (‚â§PMG-10%)</div>
                        <div id="low" class="text-xl font-bold text-red-700">0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pes√©e List Modal -->
    <div id="peseeListModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">Gestion des Pes√©es</h3>
                <button onclick="hidePeseeListModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="flex gap-2 mb-4">
                <button onclick="showCreateModal()" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm font-medium">
                    + Nouvelle Pes√©e
                </button>
                <button onclick="showImportModal()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium">
                    üì• Importer
                </button>
            </div>
            
            <!-- Search and Filter -->
            <div class="mb-4">
                <input type="text" id="searchPesees" placeholder="Rechercher une pes√©e..." 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md mb-2"
                       oninput="filterPesees()">
                <div class="flex gap-2">
                    <select id="sortPesees" onchange="sortPesees()" class="flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm">
                        <option value="name">Trier par nom</option>
                        <option value="date">Trier par date</option>
                        <option value="age">Trier par √¢ge</option>
                        <option value="created">Trier par date de cr√©ation</option>
                    </select>
                    <button onclick="toggleSortOrder()" id="sortOrder" class="px-3 py-2 bg-gray-200 rounded-md text-sm">
                        ‚Üë
                    </button>
                </div>
            </div>
            
            <div id="peseeList" class="flex flex-col gap-2 max-h-64 overflow-y-auto mb-4"></div>
            
            <!-- Statistics -->
            <div class="p-3 bg-gray-50 rounded-lg">
                <div class="text-sm text-gray-600 mb-1">Statistiques</div>
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <div>Total: <span id="totalPesees" class="font-semibold">0</span></div>
                    <div>Actif: <span id="activePesees" class="font-semibold">0</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Pes√©e Modal -->
    <div id="createModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4">Cr√©er une nouvelle pes√©e</h3>
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nom de la pes√©e</label>
                    <input type="text" id="newPeseeName" value="Pes√©e " class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">√Çge (jours)</label>
                        <input type="text" id="newPeseeAge" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                        <input type="text" id="newPeseeDate" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">B√¢timent N¬∞</label>
                    <input type="text" id="newPeseeBuilding" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Poids Norme (PN)</label>
                    <input type="number" id="newPeseeTargetWeight" value="2045" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="flex gap-2 pt-2">
                    <button onclick="hideCreateModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                        Annuler
                    </button>
                    <button onclick="createNewPeseeFromModal()" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                        Cr√©er
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4">Confirmer la suppression</h3>
            <p class="mb-4">√ätes-vous s√ªr de vouloir supprimer la pes√©e "<span id="deletePeseeName"></span>" ?</p>
            <div class="flex gap-2">
                <button onclick="hideDeleteModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                    Annuler
                </button>
                <button onclick="confirmDeletePesee()" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                    Supprimer
                </button>
            </div>
        </div>
    </div>

    <!-- Import Modal - NOUVELLE VERSION -->
    <div id="importModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h3 class="text-lg font-bold mb-4">Importer une pes√©e</h3>
            
            <!-- Onglets -->
            <div class="flex mb-2">
                <button id="tabFile" class="tab-button active" onclick="switchTab('file')">
                    üìÅ Fichier JSON
                </button>
                <button id="tabText" class="tab-button" onclick="switchTab('text')">
                    üìù Coller JSON
                </button>
            </div>
            
            <!-- Contenu de l'onglet Fichier -->
            <div id="tabFileContent" class="tab-content active">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        S√©lectionner un fichier JSON
                    </label>
                    
                    <!-- Bouton pour choisir un fichier -->
                    <div class="mb-3">
                        <input type="file" id="jsonFileInput" accept=".json" class="hidden">
                        <button type="button" onclick="document.getElementById('jsonFileInput').click()" 
                                class="w-full px-4 py-3 bg-blue-100 border-2 border-dashed border-blue-300 rounded-lg text-blue-700 hover:bg-blue-200 transition-colors flex flex-col items-center justify-center">
                            <svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            <span class="font-medium">Choisir un fichier JSON</span>
                            <span class="text-sm text-blue-600 mt-1">Cliquez ou glissez-d√©posez un fichier</span>
                        </button>
                    </div>
                    
                    <!-- Zone de glisser-d√©poser -->
                    <div id="dropZone" >
                        
                    </div>
                    
                    <!-- Informations sur le fichier s√©lectionn√© -->
                    <div id="fileInfo" class="hidden p-3 bg-green-50 border border-green-200 rounded-lg mt-3">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div>
                                    <span id="fileName" class="font-medium text-gray-700"></span>
                                    <span id="fileSize" class="text-sm text-gray-500 ml-2"></span>
                                </div>
                            </div>
                            <button type="button" onclick="clearFileSelection()" class="text-red-500 hover:text-red-700">
                                ‚úï
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="text-xs text-gray-500 mb-4">
                    <p>Le fichier doit √™tre au format JSON avec les donn√©es de pes√©e.</p>
                </div>
            </div>
            
            <!-- Contenu de l'onglet Texte -->
            <div id="tabTextContent" class="tab-content">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Coller les donn√©es JSON
                    </label>
                    <textarea id="importJsonData" 
                              class="w-full h-48 px-3 py-2 border border-gray-300 rounded-md font-mono text-sm" 
                              placeholder='{"name": "Nouvelle pes√©e", "age": "79", "date": "07/09/2022", ...}'></textarea>
                </div>
                
                <div class="text-xs text-gray-500">
                    <p>Collez ici le contenu JSON d'une pes√©e export√©e pr√©c√©demment.</p>
                </div>
            </div>
            
            <!-- Boutons d'action -->
            <div class="flex gap-2 pt-4 border-t border-gray-200">
                <button onclick="hideImportModal()" 
                        class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">
                    Annuler
                </button>
                <button onclick="importPeseeFromJson()" 
                        class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                    Importer
                </button>
            </div>
        </div>
    </div>

<script>
    const initialWeights = [
        1795, 1980, 1845, 1695, 1690, 1675, 2060, 1825, 1690,
        1830, 1830, 1800, 1755, 2040, 1555, 2050, 1775, 2110,
        2325, 1940, 1930, 1900, 1470, 1865, 2155, 2185, 2195,
        2065, 1990, 1975, 1980, 1900, 1760, 2210, 2080, 1990,
        1710, 1740, 1945, 1835, 1475, 1835, 1820, 1950, 1720,
        2070, 1770, 1740, 1665, 1965, 1830, 1800, 1810, 1635,
        1930, 1830, 2010, 1855, 1735, 1900, 1975, 1980, 1945,
        1955, 1930, 1995, 2030, 2045, 1970, 1870, 2150, 2150,
        1875, 1810, 1775, 1660, 1795, 1775, 1800, 1560, 1820,
        1840, 2025, 1990, 1785, 2330, 1895, 1875, 1990, 1675,
        1480, 1715, 1725, 1540, 1560, 1625, 1710, 1845, 1480,
        1880, 1880, 1730, 1685, 1780, 1755, 1775, 1750, 1850, 1710
    ];

    // Password management
    const PASSWORD = "1234";
    let isUnlocked = true; // Start unlocked by default

    // Pes√©e Management
    let pesees = {};
    let currentPeseeId = null;
    let sortOrder = 'asc';
    let currentSort = 'name';
    let weights = [...initialWeights];
    let groupMultipliers = [1, 1, 1, 1, 1, 1];

    // ========== MODAL MANAGEMENT FUNCTIONS ==========
    function showPeseeListModal() {
        document.getElementById('peseeListModal').style.display = 'flex';
        renderPeseeList();
    }

    function hidePeseeListModal() {
        document.getElementById('peseeListModal').style.display = 'none';
    }

    function showCreateModal() {
        document.getElementById('createModal').style.display = 'flex';
        document.getElementById('newPeseeName').value = `Pes√©e ${new Date().toLocaleDateString()}`;
        document.getElementById('newPeseeAge').value = '';
        document.getElementById('newPeseeDate').value = new Date().toLocaleDateString('fr-FR');
        document.getElementById('newPeseeBuilding').value = '';
        document.getElementById('newPeseeTargetWeight').value = '2045';
    }

    function hideCreateModal() {
        document.getElementById('createModal').style.display = 'none';
    }

    function showDeleteModal() {
        if (!currentPeseeId) {
            showToast('Aucune pes√©e s√©lectionn√©e', 'error');
            return;
        }
        document.getElementById('deletePeseeName').textContent = pesees[currentPeseeId].name;
        document.getElementById('deleteModal').style.display = 'flex';
    }

    function hideDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
    }

    function showImportModal() {
        document.getElementById('importModal').style.display = 'flex';
        switchTab('file');
    }

    function hideImportModal() {
        document.getElementById('importModal').style.display = 'none';
    }

    function switchTab(tabName) {
        document.getElementById('tabFile').classList.toggle('active', tabName === 'file');
        document.getElementById('tabText').classList.toggle('active', tabName === 'text');
        document.getElementById('tabFileContent').classList.toggle('active', tabName === 'file');
        document.getElementById('tabTextContent').classList.toggle('active', tabName === 'text');
    }

    function clearFileSelection() {
        document.getElementById('jsonFileInput').value = '';
        document.getElementById('fileInfo').classList.add('hidden');
    }

   function importPeseeFromJson() {
    let jsonText = "";

    // Case 1: user pasted JSON
    const textData = document.getElementById('importJsonData').value.trim();
    if (textData.length > 0) {
        jsonText = textData;
    }

    // Case 2: user selected a file
    const fileInput = document.getElementById('jsonFileInput');
    if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = function (e) {
            loadImportedJson(e.target.result);
        };

        reader.readAsText(file);
        return;
    }

    if (jsonText === "") {
        showToast("Aucun JSON fourni", "error");
        return;
    }

    loadImportedJson(jsonText);
}

function loadImportedJson(jsonText) {
    try {
        const data = JSON.parse(jsonText);

        const peseeId = "pesee_" + Date.now();

        pesees[peseeId] = {
            id: peseeId,
            name: data.name || "Import√©e",
            age: data.info.age,
            date: data.info.date,
            building: data.info.batiment,
            targetWeight: data.info.targetWeight,
            weights: data.groupes.flatMap(g => g.poids),
            groupMultipliers: data.groupes.map(g => g.pouletsParCase),
            createdAt: new Date().toISOString(),
            modifiedAt: new Date().toISOString()
        };

        savePesees();
        loadPesee(peseeId);
        hideImportModal();
        showToast("Import JSON r√©ussi !");
    } catch (err) {
        console.error(err);
        showToast("JSON invalide", "error");
    }
}


    // ========== UTILITY FUNCTIONS ==========
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `toast ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
        toast.classList.add('show');
        
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    function toggleLock() {
    if (isUnlocked) {
        isUnlocked = false;
        updateLockState();
        showToast('Pes√©e verrouill√©e');
    } else {
        showPasswordOverlay();
    }
}


    function showPasswordOverlay() {
        document.getElementById('passwordOverlay').classList.remove('hidden');
        document.getElementById('passwordInput').focus();
    }

    function hidePasswordOverlay() {
        document.getElementById('passwordOverlay').classList.add('hidden');
        document.getElementById('passwordInput').value = '';
    }

    function checkPassword() {
        const password = document.getElementById('passwordInput').value;
        if (password === PASSWORD) {
            isUnlocked = true;
            updateLockState();
            hidePasswordOverlay();
            showToast('Pes√©e d√©verrouill√©e');
        } else {
            showToast('Mot de passe incorrect', 'error');
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordInput').focus();
        }
    }

function updateLockState() {
    const lockButton = document.getElementById('lockButton');

    // Weight inputs in the 6 groups
    const weightInputs = document.querySelectorAll('#groupsContainer input[type="number"]');

    // Group multipliers
    const groupMultiplierInputs = document.querySelectorAll('input[onchange*="setGroupMultiplier"]');

    // üî• FIX: top form inputs (AGE, DATE, BATIMENT, PN)
    const headerInputs = document.querySelectorAll('.grid input');

    if (isUnlocked) {
        // ---- UNLOCK ALL ----
        lockButton.textContent = 'üîì D√©verrouill√©';
        lockButton.className = 'px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm font-medium';

        weightInputs.forEach(i => i.disabled = false);
        groupMultiplierInputs.forEach(i => i.disabled = false);
        headerInputs.forEach(i => i.disabled = false);   // üî• FIX HERE

    } else {
        // ---- LOCK ALL ----
        lockButton.textContent = 'üîí Verrouill√©';
        lockButton.className = 'px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 text-sm font-medium';

        weightInputs.forEach(i => i.disabled = true);
        groupMultiplierInputs.forEach(i => i.disabled = true);
        headerInputs.forEach(i => i.disabled = true);    // üî• FIX HERE
    }
}




    // ========== PESEE MANAGEMENT FUNCTIONS ==========
    async function initializePesees() {
        // Try to load from localStorage first
        const savedPesees = localStorage.getItem('pesees');
        if (savedPesees) {
            pesees = JSON.parse(savedPesees);
        }
        
        // If no saved pesees, create a default one
        if (Object.keys(pesees).length === 0) {
            await createNewPesee();
        } else {
            // Load the first pes√©e
            const firstPeseeId = Object.keys(pesees)[0];
            loadPesee(firstPeseeId);
        }
        
        renderPeseeList();
        updateLockState(); // This will set the initial lock state
    }

    async function createNewPesee() {
        const peseeId = 'pesee_' + Date.now();
        const newPesee = {
            id: peseeId,
            name: `Pes√©e ${new Date().toLocaleDateString()}`,
            age: "79",
            date: new Date().toLocaleDateString('fr-FR'),
            building: "",
            targetWeight: 2045,
            weights: Array(108).fill(0),
            groupMultipliers: [1, 1, 1, 1, 1, 1],
            createdAt: new Date().toISOString(),
            modifiedAt: new Date().toISOString()
        };
        
        pesees[peseeId] = newPesee;
        await savePesees();
        loadPesee(peseeId);
        renderPeseeList();
        showToast('Nouvelle pes√©e cr√©√©e!');
        return peseeId;
    }

    function createNewPeseeFromModal() {
        const name = document.getElementById('newPeseeName').value.trim();
        const age = document.getElementById('newPeseeAge').value;
        const date = document.getElementById('newPeseeDate').value;
        const building = document.getElementById('newPeseeBuilding').value;
        const targetWeight = parseFloat(document.getElementById('newPeseeTargetWeight').value) || 2045;

        if (!name) {
            showToast('Veuillez entrer un nom pour la pes√©e', 'error');
            return;
        }

        const peseeId = 'pesee_' + Date.now();
        const newPesee = {
            id: peseeId,
            name: name,
            age: age || "79",
            date: date || new Date().toLocaleDateString('fr-FR'),
            building: building,
            targetWeight: targetWeight,
            weights: Array(108).fill(0),
            groupMultipliers: [1, 1, 1, 1, 1, 1],
            createdAt: new Date().toISOString(),
            modifiedAt: new Date().toISOString()
        };
        
        pesees[peseeId] = newPesee;
        savePesees();
        loadPesee(peseeId);
        hideCreateModal();
        renderPeseeList();
        showToast('Nouvelle pes√©e cr√©√©e!');
    }

    function duplicateCurrentPesee() {
        if (!currentPeseeId) {
            showToast('Aucune pes√©e √† dupliquer', 'error');
            return;
        }

        const currentPesee = pesees[currentPeseeId];
        const peseeId = 'pesee_' + Date.now();
        const duplicatedPesee = {
            ...currentPesee,
            id: peseeId,
            name: `${currentPesee.name} (copie)`,
            createdAt: new Date().toISOString(),
            modifiedAt: new Date().toISOString()
        };
        
        pesees[peseeId] = duplicatedPesee;
        savePesees();
        loadPesee(peseeId);
        renderPeseeList();
        showToast('Pes√©e dupliqu√©e!');
    }

    function loadPesee(id) {
        const pesee = pesees[id];
        if (!pesee) return;

        currentPeseeId = id;
        weights = [...pesee.weights];
        groupMultipliers = (pesee.groupMultipliers && Array.isArray(pesee.groupMultipliers)) 
            ? [...pesee.groupMultipliers] 
            : [1, 1, 1, 1, 1, 1];

        // Update UI
        document.getElementById('currentPeseeTitle').textContent = pesee.name;
        document.getElementById('currentPeseeDate').textContent = `Date: ${pesee.date}`;
        document.getElementById('currentPeseeAge').textContent = `√Çge: ${pesee.age}`;
        document.getElementById('currentPeseeBuilding').textContent = `B√¢timent: ${pesee.building}`;
        
        document.getElementById('age').value = pesee.age;
        document.getElementById('date').value = pesee.date;
        document.getElementById('building').value = pesee.building;
        document.getElementById('targetWeight').value = pesee.targetWeight;

        renderGroups();
        renderPeseeList();
        hidePeseeListModal();
        
        // Keep the current lock state when loading a pes√©e
        updateLockState();
    }

async function saveCurrentPesee() {
    if (!currentPeseeId) return false;

    if (!isUnlocked) {
        showToast('Veuillez d√©verrouiller la pes√©e pour la modifier', 'error');
        return false;
    }

    // Build updated pes√©e object
    const updated = {
        ...pesees[currentPeseeId],      // keep previous fields (name, createdAt, etc.)
        age: document.getElementById('age').value,
        date: document.getElementById('date').value,
        building: document.getElementById('building').value,
        targetWeight: parseFloat(document.getElementById('targetWeight').value) || 2045,
        weights: [...weights],                  // SAVE REAL VALUES
        groupMultipliers: [...groupMultipliers], // SAVE MULTIPLIERS
        modifiedAt: new Date().toISOString()
    };

    pesees[currentPeseeId] = updated;

    const success = await savePesees();
    renderPeseeList();
    return success;
}


    async function saveCurrentPeseeWithFeedback() {
        if (await saveCurrentPesee()) {
            showToast('Pes√©e sauvegard√©e avec succ√®s!');
        } else {
            showToast('Erreur lors de la sauvegarde', 'error');
        }
    }

    async function savePesees() {
    return { success: true }; // No saving
}


    function deletePeseeFromList(id, event) {
        if (event) event.stopPropagation();
        
        if (!isUnlocked) {
            showToast('Veuillez d√©verrouiller la pes√©e pour la supprimer', 'error');
            return;
        }

        if (Object.keys(pesees).length <= 1) {
            showToast('Impossible de supprimer la derni√®re pes√©e', 'error');
            return;
        }

        const pesee = pesees[id];
        if (confirm(`√ätes-vous s√ªr de vouloir supprimer la pes√©e "${pesee.name}" ?`)) {
            delete pesees[id];
            savePesees();
            
            if (id === currentPeseeId) {
                const remainingIds = Object.keys(pesees);
                if (remainingIds.length > 0) {
                    loadPesee(remainingIds[0]);
                } else {
                    createNewPesee();
                }
            }
            
            renderPeseeList();
            showToast('Pes√©e supprim√©e!');
        }
    }

    function confirmDeletePesee() {
        if (!currentPeseeId) return;
        
        if (!isUnlocked) {
            showToast('Veuillez d√©verrouiller la pes√©e pour la supprimer', 'error');
            hideDeleteModal();
            return;
        }

        if (Object.keys(pesees).length <= 1) {
            showToast('Impossible de supprimer la derni√®re pes√©e', 'error');
            hideDeleteModal();
            return;
        }

        delete pesees[currentPeseeId];
        savePesees();
        
        const remainingIds = Object.keys(pesees);
        if (remainingIds.length > 0) {
            loadPesee(remainingIds[0]);
        } else {
            createNewPesee();
        }
        
        hideDeleteModal();
        renderPeseeList();
        showToast('Pes√©e supprim√©e!');
    }

    async function renamePesee(id, event) {
        if (event) event.stopPropagation();
        
        if (!isUnlocked) {
            showToast('Veuillez d√©verrouiller la pes√©e pour la renommer', 'error');
            return;
        }
        
        const newName = prompt('Nouveau nom:', pesees[id].name);
        if (newName && newName.trim()) {
            pesees[id].name = newName.trim();
            pesees[id].modifiedAt = new Date().toISOString();
            await savePesees();
            renderPeseeList();
            if (id === currentPeseeId) {
                document.getElementById('currentPeseeTitle').textContent = newName.trim();
            }
            showToast('Nom modifi√© avec succ√®s!');
        }
    }

    function updatePeseeStatistics() {
        const total = Object.keys(pesees).length;
        const active = Object.values(pesees).filter(p => 
            p.weights && p.weights.some(w => w > 0)
        ).length;
        
        document.getElementById('totalPesees').textContent = total;
        document.getElementById('activePesees').textContent = active;
    }

    function filterPesees() {
        const searchTerm = document.getElementById('searchPesees').value.toLowerCase();
        renderPeseeList(searchTerm);
    }

    function sortPesees() {
        currentSort = document.getElementById('sortPesees').value;
        renderPeseeList();
    }

    function toggleSortOrder() {
        sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
        document.getElementById('sortOrder').textContent = sortOrder === 'asc' ? '‚Üë' : '‚Üì';
        renderPeseeList();
    }

    function renderPeseeList(searchTerm = '') {
        const container = document.getElementById('peseeList');
        container.innerHTML = '';
        
        let peseesArray = Object.values(pesees);
        
        if (searchTerm) {
            peseesArray = peseesArray.filter(pesee => 
                pesee.name.toLowerCase().includes(searchTerm) ||
                pesee.date.includes(searchTerm) ||
                pesee.building.toLowerCase().includes(searchTerm)
            );
        }
        
        peseesArray.sort((a, b) => {
            let aValue, bValue;
            
            switch (currentSort) {
                case 'name':
                    aValue = a.name.toLowerCase();
                    bValue = b.name.toLowerCase();
                    break;
                case 'date':
                    aValue = new Date(a.date.split('/').reverse().join('-'));
                    bValue = new Date(b.date.split('/').reverse().join('-'));
                    break;
                case 'age':
                    aValue = parseInt(a.age) || 0;
                    bValue = parseInt(b.age) || 0;
                    break;
                case 'created':
                    aValue = new Date(a.createdAt);
                    bValue = new Date(b.createdAt);
                    break;
                default:
                    aValue = a.name.toLowerCase();
                    bValue = b.name.toLowerCase();
            }
            
            if (sortOrder === 'asc') {
                return aValue < bValue ? -1 : aValue > bValue ? 1 : 0;
            } else {
                return aValue > bValue ? -1 : aValue < bValue ? 1 : 0;
            }
        });
        
        peseesArray.forEach(pesee => {
            const div = document.createElement('div');
            div.className = `pesee-item flex items-center gap-2 px-3 py-2 rounded-md border-2 cursor-pointer ${
                pesee.id === currentPeseeId 
                    ? 'bg-blue-100 border-blue-500' 
                    : 'bg-gray-100 border-gray-300 hover:bg-gray-200'
            }`;
            
            const hasData = pesee.weights && pesee.weights.some(w => w > 0);
            const dataIndicator = hasData ? 
                '<span class="w-2 h-2 bg-green-500 rounded-full" title="Contient des donn√©es"></span>' : 
                '<span class="w-2 h-2 bg-gray-300 rounded-full" title="Vide"></span>';
            
            div.innerHTML = `
                ${dataIndicator}
                <span class="flex-1 font-medium truncate" onclick="loadPesee('${pesee.id}')">${pesee.name}</span>
                <span class="text-xs text-gray-500">${pesee.date}</span>
                <div class="flex gap-1">
                    <button onclick="renamePesee('${pesee.id}', event)" class="text-gray-600 hover:text-blue-600 text-sm p-1 rounded hover:bg-blue-100" title="Renommer">
                        ‚úèÔ∏è
                    </button>
                    <button onclick="deletePeseeFromList('${pesee.id}', event)" class="text-gray-600 hover:text-red-600 text-sm p-1 rounded hover:bg-red-100" title="Supprimer">
                        üóëÔ∏è
                    </button>
                </div>
            `;
            
            container.appendChild(div);
        });
        
        if (peseesArray.length === 0) {
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'text-center text-gray-500 py-4';
            emptyDiv.textContent = 'Aucune pes√©e trouv√©e';
            container.appendChild(emptyDiv);
        }
        
        updatePeseeStatistics();
    }

    // ========== WEIGHT MANAGEMENT FUNCTIONS ==========
    function calculateAverage(arr) {
        const filtered = arr.filter(w => w > 0);
        if (filtered.length === 0) return 0;
        const sum = filtered.reduce((a, b) => a + b, 0);
        return sum / filtered.length;
    }

    function calculateStats() {
        const targetWeight = parseFloat(document.getElementById('targetWeight').value) || 2045;
        const groupSums = [];
        const groupFilledCounts = [];
        
        for (let i = 0; i < 6; i++) {
            const startIndex = i * 18;
            const group = weights.slice(startIndex, startIndex + 18);
            let sum = 0;
            let filled = 0;
            group.forEach(w => {
                if (w > 0) {
                    sum += w;
                    filled += 1;
                }
            });
            groupSums.push(sum);
            groupFilledCounts.push(filled);
        }
        
        const groupAverages = [];
        for (let i = 0; i < 6; i++) {
            const M = groupMultipliers[i] || 1;
            const filled = groupFilledCounts[i];
            if (filled > 0) {
                groupAverages.push(groupSums[i] / (M * filled));
            } else {
                groupAverages.push(0);
            }
        }
        
        const validGroups = groupAverages.filter(avg => avg > 0);

const pmgRaw = validGroups.length > 0 
    ? validGroups.reduce((a, b) => a + b, 0) / validGroups.length 
    : 0;

        const roundedPmg = Math.ceil(pmgRaw);
        const ecart = roundedPmg === 0 ? 0 : ((roundedPmg - targetWeight) / roundedPmg) * 100;
        const upperLimit = roundedPmg + (roundedPmg / 10);
        const lowerLimit = roundedPmg - (roundedPmg / 10);
        // If any group multiplier is greater than 1, disable H / H% / LOW calculations
const disableH = groupMultipliers.some(m => m > 1);
if (disableH) {
    return { 
        pmg: roundedPmg,
        pn: targetWeight,
        ecart,
        h: 0,
        hPercent: 0,
        low: 0,
        upperLimit,
        lowerLimit
    };
}

        let totalChickens = 0;
        let aboveTargetChickens = 0;
        let belowTargetChickens = 0;
        
        for (let i = 0; i < 6; i++) {
            const M = groupMultipliers[i] || 1;
            const startIndex = i * 18;
            const group = weights.slice(startIndex, startIndex + 18);
            group.forEach(w => {
                if (w > 0) {
                    totalChickens += M;
                   let disableH = groupMultipliers.some(m => m > 1);

                    if (!disableH) {
                    if (w >= upperLimit) aboveTargetChickens += M;
                    else if (w <= lowerLimit) belowTargetChickens += M;
}
                }
            });
        }
        
        const hPercent = totalChickens === 0 ? 0 : ((totalChickens - (aboveTargetChickens + belowTargetChickens)) / totalChickens) * 100;
        
        return { 
            pmg: roundedPmg, 
            pn: targetWeight, 
            ecart, 
            h: aboveTargetChickens, 
            hPercent, 
            low: belowTargetChickens, 
            upperLimit, 
            lowerLimit 
        };
    }

    function updateStats() {
        const stats = calculateStats();
        document.getElementById('pmg').textContent = stats.pmg;
        document.getElementById('pn').textContent = stats.pn;
        
        const ecartEl = document.getElementById('ecart');
        ecartEl.textContent = stats.ecart.toFixed(2);
        ecartEl.className = `text-xl font-bold ${stats.ecart < 0 ? 'text-red-600' : 'text-green-600'}`;
        
        document.getElementById('h').textContent = stats.h;
        document.getElementById('hPercent').textContent = stats.hPercent.toFixed(2);
        document.getElementById('low').textContent = stats.low;
        document.getElementById('upperLimitText').textContent = `‚â• ${Math.round(stats.upperLimit / 5) * 5} (PMG+10%)`;
        document.getElementById('lowerLimitText').textContent = `‚â§ ${Math.round(stats.lowerLimit / 5) * 5} (PMG-10%)`;
        
        return stats;
    }

    function getColorClass(weight, stats) {

    // Disable coloring if any GroupMultiplier > 1
    if (groupMultipliers.some(m => m > 1)) {
        return 'bg-white text-gray-900 border-gray-300';
    }

    if (weight === 0) return 'bg-gray-100 text-gray-400 border-gray-300';
    if (weight >= stats.upperLimit) return 'bg-blue-200 text-blue-900 border-blue-400';
    if (weight <= stats.lowerLimit) return 'bg-red-200 text-red-900 border-red-400';
    return 'bg-yellow-100 text-gray-900 border-yellow-400';
}


    function updateWeight(index, value) {
        if (!isUnlocked) {
            showToast('Veuillez d√©verrouiller la pes√©e pour modifier les poids', 'error');
            return;
        }
        
        weights[index] = value === '' ? 0 : parseFloat(value) || 0;
        saveCurrentPesee();
        renderGroups();
    }

    function setGroupMultiplier(index, value) {
        const v = parseInt(value) || 1;
        groupMultipliers[index] = v;
        saveCurrentPesee();
        renderGroups();
    }

    function renderGroups() {
        const stats = updateStats();
        const container = document.getElementById('groupsContainer');
        container.innerHTML = '';
        
        for (let groupIndex = 0; groupIndex < 6; groupIndex++) {
            const startIndex = groupIndex * 18;
            const group = weights.slice(startIndex, startIndex + 18);
           // Correct group average: sum / (M * filled count)
let M = groupMultipliers[groupIndex] || 1;

let filled = group.filter(w => w > 0).length;
let groupSum = group.reduce((a, b) => a + (b > 0 ? b : 0), 0);

let average = filled > 0 ? groupSum / (M * filled) : 0;

            
            const groupDiv = document.createElement('div');
            groupDiv.className = 'border border-gray-300 rounded-lg p-3 bg-white';
            
            const header = document.createElement('div');
            header.className = 'font-semibold mb-2 text-gray-700 flex items-center justify-between';
            header.innerHTML = `
                <div class="flex items-center gap-3">
                  <span>Groupe ${groupIndex + 1}</span>
                  <span class="text-sm bg-purple-100 px-3 py-1 rounded border border-purple-300">
                      Moyenne: ${Math.ceil(average)}
                  </span>
                </div>
                <div class="text-xs text-gray-600">
                  <label class="mr-2">Poulets par case:</label>
                  <input type="number" min="1" value="${groupMultipliers[groupIndex] || 1}" onchange="setGroupMultiplier(${groupIndex}, this.value)" class="w-16 px-2 py-1 border rounded text-sm" ${!isUnlocked ? 'disabled' : ''}>
                </div>
            `;
            groupDiv.appendChild(header);
            
            const rowsDiv = document.createElement('div');
            rowsDiv.className = 'flex flex-col gap-2';
            
            // First row (0-8)
            const row1 = document.createElement('div');
            row1.className = 'grid grid-cols-9 gap-2';
            for (let i = 0; i < 9; i++) {
                const absoluteIndex = startIndex + i;
                const input = document.createElement('input');
                input.type = 'number';
                input.value = weights[absoluteIndex] === 0 ? '' : weights[absoluteIndex];
                input.placeholder = '0';
                input.disabled = !isUnlocked;
                input.className = `w-full p-2 text-center text-sm font-mono rounded border-2 ${getColorClass(weights[absoluteIndex], stats)}`;
                input.addEventListener('change', (e) => updateWeight(absoluteIndex, e.target.value));
                row1.appendChild(input);
            }
            
            // Second row (9-17)
            const row2 = document.createElement('div');
            row2.className = 'grid grid-cols-9 gap-2';
            for (let i = 9; i < 18; i++) {
                const absoluteIndex = startIndex + i;
                const input = document.createElement('input');
                input.type = 'number';
                input.value = weights[absoluteIndex] === 0 ? '' : weights[absoluteIndex];
                input.placeholder = '0';
                input.disabled = !isUnlocked;
                input.className = `w-full p-2 text-center text-sm font-mono rounded border-2 ${getColorClass(weights[absoluteIndex], stats)}`;
                input.addEventListener('change', (e) => updateWeight(absoluteIndex, e.target.value));
                row2.appendChild(input);
            }
            
            rowsDiv.appendChild(row1);
            rowsDiv.appendChild(row2);
            groupDiv.appendChild(rowsDiv);
            container.appendChild(groupDiv);
        }
    }

    // ========== EXPORT FUNCTIONS ==========
    function getCellColor(weight, stats) {
        if (weight === 0) return { fill: [240, 240, 240], text: [160, 160, 160] };
        if (weight >= stats.upperLimit) return { fill: [191, 219, 254], text: [30, 58, 138] };
        if (weight <= stats.lowerLimit) return { fill: [254, 202, 202], text: [127, 29, 29] };
        return { fill: [255, 255, 255], text: [0, 0, 0] };
    }
    
function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const stats = calculateStats();

    const primaryColor = [0, 0, 0];
    const secondaryColor = [100, 100, 100];
    const accentColor = [150, 150, 150];

    doc.setFont("helvetica", "bold");
    doc.setFontSize(16);
    doc.setTextColor(...primaryColor);

    doc.text(`L'Age : ${document.getElementById('age').value}`, 20, 20);

    const dateText = document.getElementById('date').value;
    const dateWidth = doc.getTextWidth(dateText);
    doc.text(dateText, 190 - dateWidth, 20);

    doc.setFontSize(18);
    doc.text("La pes√©e du poulet", 105, 30, { align: 'center' });

    doc.setFontSize(14);
    doc.setFont("helvetica", "normal");
    doc.text(`B√¢timent N¬∞ : ${document.getElementById('building').value || ''}`, 20, 40);

    const groupNames = ["G1", "G2", "G3", "G4", "G5", "G6"];

    const startX = 20;
    let startY = 50;
    const cellWidth = 18;
    const cellHeight = 7;
    const valuesPerRow = 9;

    function getCellColorPDF(weight, stats) {
        if (groupMultipliers.some(m => m > 1)) {
            return { fill: [255, 255, 255], text: [0, 0, 0] };
        }

        if (weight === 0) return { fill: [240, 240, 240], text: [160, 160, 160] };
        if (weight >= stats.upperLimit) return { fill: [191, 219, 254], text: [30, 58, 138] };
        if (weight <= stats.lowerLimit) return { fill: [254, 202, 202], text: [127, 29, 29] };
        return { fill: [255, 255, 255], text: [0, 0, 0] };
    }

    // DRAW GROUP TABLES
    for (let groupIndex = 0; groupIndex < 6; groupIndex++) {
        const startIndex = groupIndex * 18;
        const groupWeights = weights.slice(startIndex, startIndex + 18);

        const M = groupMultipliers[groupIndex] || 1;

        const filtered = groupWeights.filter(w => w > 0);
        const sum = filtered.reduce((a, b) => a + b, 0);
        const groupAvg = filtered.length > 0 ? sum / (M * filtered.length) : 0;

        // HEADER FIXED
        const headerHeight = 8;
        const headerY = startY - 2;

        doc.setFillColor(0, 0, 0);
        doc.rect(startX, headerY, valuesPerRow * cellWidth, headerHeight, 'F');

        doc.setDrawColor(...accentColor);
        doc.rect(startX, headerY, valuesPerRow * cellWidth, headerHeight);

        // SHOW MULTIPLIER
        const groupLabel = M === 1 ? groupNames[groupIndex] : `${groupNames[groupIndex]} (x${M})`;

        doc.setFontSize(11);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(255, 255, 255);
        doc.text(groupLabel, startX + (valuesPerRow * cellWidth) / 2, headerY + 5, { align: 'center' });

        doc.setTextColor(...primaryColor);

        // FIRST ROW FIXED
        const row1Y = startY + 7;
        for (let i = 0; i < valuesPerRow; i++) {
            const x = startX + (i * cellWidth);
            const weight = groupWeights[i] || 0;
            const colors = getCellColorPDF(weight, stats);

            doc.setFillColor(...colors.fill);
            doc.rect(x, row1Y, cellWidth, cellHeight, 'F');

            doc.setDrawColor(...accentColor);
            doc.rect(x, row1Y, cellWidth, cellHeight);

            if (weight > 0) {
                doc.setFontSize(9);
                doc.setFont("helvetica", "normal");
                doc.setTextColor(...colors.text);
                doc.text(weight.toString(), x + cellWidth / 2, row1Y + 4.5, { align: 'center' });
            }
        }

        // SECOND ROW FIXED
        const row2Y = startY + 14;
        for (let i = 0; i < valuesPerRow; i++) {
            const x = startX + (i * cellWidth);
            const weight = groupWeights[i + valuesPerRow] || 0;
            const colors = getCellColorPDF(weight, stats);

            doc.setFillColor(...colors.fill);
            doc.rect(x, row2Y, cellWidth, cellHeight, 'F');

            doc.setDrawColor(...accentColor);
            doc.rect(x, row2Y, cellWidth, cellHeight);

            if (weight > 0) {
                doc.setFontSize(9);
                doc.setFont("helvetica", "normal");
                doc.setTextColor(...colors.text);
                doc.text(weight.toString(), x + cellWidth / 2, row2Y + 4.5, { align: 'center' });
            }
        }

        // AVERAGE CELL
        const avgX = startX + (valuesPerRow * cellWidth);
        const avgY = row2Y;

        doc.setFillColor(240, 240, 240);
        doc.rect(avgX, avgY, cellWidth, cellHeight, 'F');
        doc.rect(avgX, avgY, cellWidth, cellHeight);

        doc.setFontSize(9);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(...primaryColor);
        doc.text(Math.ceil(groupAvg).toString(), avgX + cellWidth / 2, avgY + 4.5, { align: 'center' });

        startY += 28; // ‚Üê FIXED spacing so table never disappears
    }

    //
    // ------------- STATISTICS TABLE -------------
    //

    const statsY = startY + 10;
    const rowHeight = 8;

    const pageWidth = 210;
    const tableWidth = 160;
    const tableX = (pageWidth - tableWidth) / 2;

    const col1 = 15, col2 = 30, col3 = 30, col4 = 20, col5 = 35, col6 = 30;

    const upperLimit = Math.round(stats.upperLimit * 10) / 10;
    const lowerLimit = Math.round(stats.lowerLimit * 10) / 10;

    let y = statsY;

    // -------- ROW 1 : PMG / H --------
    doc.setFillColor(0, 0, 139);
    doc.rect(tableX, y, col1, rowHeight, 'F');
    doc.setTextColor(255, 255, 255);
    doc.text("H>=", tableX + col1 / 2, y + 5.5, { align: 'center' });

    let x = tableX + col1;

    function drawCell(val, width, bg) {
        doc.setFillColor(...bg);
        doc.rect(x, y, width, rowHeight, 'F');
        doc.rect(x, y, width, rowHeight);
        doc.setTextColor(0, 0, 0);
        doc.text(val.toString(), x + width / 2, y + 5.5, { align: 'center' });
        x += width;
    }

    drawCell(upperLimit.toFixed(1), col2, [173, 216, 230]);
    drawCell(Math.round(stats.upperLimit / 5) * 5, col3, [173, 216, 230]);
    drawCell(stats.h, col4, [173, 216, 230]);

    // PMG label
    doc.setFillColor(255, 255, 255);
    doc.rect(x, y, col5, rowHeight, 'F');
    doc.text("PMG =", x + col5 / 2, y + 5.5, { align: 'center' });
    x += col5;

    // PMG value
    doc.setFillColor(0, 0, 0);
    doc.rect(x, y, col6, rowHeight, 'F');
    doc.setTextColor(255, 255, 255);
    doc.text(stats.pmg.toString(), x + col6 / 2, y + 5.5, { align: 'center' });

    // -------- ROW 2 : PN / LOW --------
    y += rowHeight;
    x = tableX + col1;

    doc.setFillColor(139, 0, 0);
    doc.rect(tableX, y, col1, rowHeight, 'F');
    doc.setTextColor(255, 255, 255);
    doc.text("H<=", tableX + col1 / 2, y + 5.5, { align: 'center' });

    drawCell(lowerLimit.toFixed(1), col2, [255, 182, 193]);
    drawCell(Math.round(stats.lowerLimit / 5) * 5, col3, [255, 182, 193]);
    drawCell(stats.low, col4, [255, 182, 193]);

    // PN label
    doc.setFillColor(255, 255, 255);
    doc.rect(x, y, col5, rowHeight, 'F');
    doc.setTextColor(0, 0, 0);
    doc.text("PN =", x + col5 / 2, y + 5.5, { align: 'center' });
    x += col5;

    // PN value
    doc.setFillColor(0, 0, 0);
    doc.rect(x, y, col6, rowHeight, 'F');
    doc.setTextColor(255, 255, 255);
    doc.text(stats.pn.toString(), x + col6 / 2, y + 5.5, { align: 'center' });

    // -------- ROW 3 : ECART --------
    y += rowHeight;
    x = tableX + col1 + col2 + col3 + col4;

    doc.setFillColor(255, 255, 255);
    doc.rect(tableX, y, col1 + col2 + col3 + col4, rowHeight, 'F');

    doc.rect(x, y, col5, rowHeight, 'F');
    doc.setTextColor(0, 0, 0);
    doc.text("ECART =", x + col5 / 2, y + 5.5, { align: 'center' });

    x += col5;

    const ecartColor = stats.ecart >= 0 ? [0, 128, 0] : [139, 0, 0];
    doc.setFillColor(...ecartColor);
    doc.rect(x, y, col6, rowHeight, 'F');
    doc.setTextColor(255, 255, 255);
    doc.text((stats.ecart >= 0 ? "+" : "") + stats.ecart.toFixed(4), x + col6 / 2, y + 5.5, { align: 'center' });

    // -------- ROW 4 : H% --------
    y += rowHeight;
    x = tableX + col1 + col2 + col3 + col4;

    doc.setFillColor(255, 255, 255);
    doc.rect(tableX, y, col1 + col2 + col3 + col4, rowHeight, 'F');

    doc.rect(x, y, col5, rowHeight, 'F');
    doc.text("H % =", x + col5 / 2, y + 5.5, { align: 'center' });

    x += col5;

    doc.setFillColor(0, 0, 0);
    doc.rect(x, y, col6, rowHeight, 'F');
    doc.setTextColor(255, 255, 255);
    doc.text(stats.hPercent.toFixed(5), x + col6 / 2, y + 5.5, { align: 'center' });

    // SAVE PDF
    const pesee = pesees[currentPeseeId];
    doc.save(`pesee-poulet-${pesee.name.replace(/\s+/g, '_')}.pdf`);
}




    function exportCSV() {
        const stats = calculateStats();
        let csv = 'Groupe,Position,Poids\n';
        
        for (let i = 0; i < 6; i++) {
            const startIndex = i * 18;
            const group = weights.slice(startIndex, startIndex + 18);
            group.forEach((weight, index) => {
                csv += `${i + 1},${index + 1},${weight}\n`;
            });
        }
        
        csv += '\n\nStatistiques\n';
        csv += `PMG,${stats.pmg}\n`;
        csv += `PN,${stats.pn}\n`;
        csv += `ECART,${stats.ecart.toFixed(2)}\n`;
        csv += `H,${stats.h}\n`;
        csv += `H%,${stats.hPercent.toFixed(2)}\n`;
        csv += `Bas,${stats.low}\n`;
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const pesee = pesees[currentPeseeId];
        a.download = `pesee-poulet-${pesee.name.replace(/\s+/g, '-')}.csv`;
        a.click();
        showToast('Export CSV r√©ussi!');
    }
    
    function exportJSON() {
        const stats = calculateStats();
        const data = {
            info: {
                age: document.getElementById('age').value,
                date: document.getElementById('date').value,
                batiment: document.getElementById('building').value,
                pn: stats.pn
            },
            statistiques: {
                pmg: stats.pmg,
                pn: stats.pn,
                ecart: parseFloat(stats.ecart.toFixed(2)),
                h: stats.h,
                hPercent: parseFloat(stats.hPercent.toFixed(2)),
                bas: stats.low
            },
            groupes: []
        };
        
        for (let i = 0; i < 6; i++) {
            const startIndex = i * 18;
            const group = weights.slice(startIndex, startIndex + 18);
            const average = calculateAverage(group);
            data.groupes.push({
                numero: i + 1,
                moyenne: Math.ceil(average),
                poids: group,
                pouletsParCase: groupMultipliers[i] || 1
            });
        }
        
        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const pesee = pesees[currentPeseeId];
        a.download = `pesee-poulet-${pesee.name.replace(/\s+/g, '-')}.json`;
        a.click();
        showToast('Export JSON r√©ussi!');
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async function() {
        await initializePesees();
        // Make sure the page starts in an unlocked state
        isUnlocked = false;
        updateLockState();
    });
</script>
</body>
</html>